<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script> <!-- Remember to add in Axios Script -->
    <script type="text/javascript" src="commons.js"></script>
    <title>Stripe Testing</title>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="input-field col s4">
                <input id="tomato" type="number" class="validate">
                <label for="tomato">Tomatoes</label>
            </div>
            <div class="input-field col s4">
                <input id="corriander" type="number" class="validate">
                <label for="corriander">Corrianders</label>
            </div>
            <div class="input-field col s4">
                <input id="potato" type="number" class="validate">
                <label for="potato">Potatoes</label>
            </div>
        </div>

        <button class="btn waves-effect waves-light" name="action"  onClick="processPayment()">BUY</button>
    </div>

    <div class="container" id="qrCode">
    </div>

    <script>
        // These variables can be extracted from the database.
        const products = [
        {item: 'tomato', unitPrice: 4.5},
        {item: 'corriander', unitPrice: 3},
        {item: 'potato', unitPrice: 3.7}
        ];
        const months = {'Jan': '01', 'Feb': '01', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'}

        // This function's purpose is to generate a custom PayNow QR Code based on the inputs (Item Quantity in Cart) provided.
        function processPayment() {
            let output = 0;
            let data = [];

            data.push(document.getElementById('tomato').value);
            data.push(document.getElementById('corriander').value);
            data.push(document.getElementById('potato').value);

            // Computing the total price
            for (i in data) {
                if (data[i] !== '') {
                    let qty = Number(data[i]);
                    output += products[i].unitPrice * qty;
                }
            }
            output = String(output);
            
            // Determining the date the PayNow QR will expire by through UNIX Timestamps conversion
            let today = new Date(); // Obtains Current DateTime UNIX Timestamp.
            let todaySplit = String(new Date(today)).split(' '); // Convert into Standardised DateTime.

            let year = todaySplit[3]; // Obtains Year
            let month = todaySplit[1]; // Obtains Month Name
            month = months[month]; // Changes Month Name to Month Number
            let day = String(Number(todaySplit[2]) + 1); // Obtains Day of Month. +1 to indicate 24 Hours later.

            let time = todaySplit[4].split(':'); // Obtains HH:MM:SS
            let hour = time[0]; // Obtains Hour of Day
            let minute = time[1]; // Obtains Minute of Hour

            // Appends all obtained information into QR Generation Link.
            let qr = 
                'https://sgqr.fullstacksys.com/paynow?mobile=90667672&uen=&editable=0&amount=' // Paid to my Phone No.. Can be changed.
                + output + '&expiry='
                + year + '%2F'
                + month + '%2F' 
                + day + '%20' 
                + hour + '%3A' 
                + minute + '&ref_id=&company=';

            console.log(output);
            // Embeds QR Code onto Screen.
            document.getElementById('qrCode').innerHTML = `<img  src='` + qr + `'>`;
        }
    </script>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</html>